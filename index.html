<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The New Invisible College</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --paper-bg: #faf8f2;
            --paper-border: #d4cfc3;
            --ink: #3a3a3a;
            --ink-soft: #615c54;
            --accent: #8c6b45; 
        }

        body {
            margin: 0; padding: 0;
            font-family: "Libre Baskerville", "Times New Roman", serif;
            background: var(--paper-bg); color: var(--ink);
            overflow: hidden; 
        }

        header {
            text-align: center; padding: 1.5rem 0;
            border-bottom: 1px solid var(--paper-border);
            background: var(--paper-bg);
            z-index: 100; position: relative;
        }

        .container {
            display: flex; height: calc(100vh - 100px);
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 350px; border-right: 1px solid var(--paper-border);
            background: #fdfbf6; padding: 20px;
            overflow-y: auto; z-index: 10;
        }

        .sidebar h2 { font-size: 1.3rem; color: var(--accent); margin-top: 0; }
        .relation-box { 
            padding: 10px; 
            font-size: 0.85rem; 
            border-radius: 4px; /* 加一点圆角 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.03); /* 给内部小卡片加一点点投影 */
        }

        /* Diagram Area */
        .diagram-container {
            flex: 1; position: relative; cursor: grab;
            background-color: #ffffff;
            user-select: none;
            overflow: hidden;
        }

        .diagram-container:active { cursor: grabbing; }
        svg { width: 100%; height: 100%; }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 999;
        }
        
        .zoom-btn {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .zoom-btn:hover {
            background: #6d5234;
            transform: translateY(-2px);
        }

        /* Elements */
        .link { stroke: #d4cfc3; stroke-opacity: 0.5; stroke-width: 1.5; fill: none; transition: 0.3s; }
        .link.active { stroke: var(--accent); stroke-opacity: 1; stroke-width: 2.5; }
        .node circle { fill: white; stroke-width: 3; transition: 0.3s; }
        .node:hover circle { fill: #fff5e6; r: 15; }
        .node-text { font-size: 11px; fill: var(--ink); pointer-events: none; font-weight: bold; }
        /* 找到或添加这个类 */
        .link-num { 
            font-size: 10px; 
            fill: var(--accent); 
            font-weight: bold; 
            paint-order: stroke; 
            stroke: #fff; 
            stroke-width: 3px; 
            pointer-events: none; 
            opacity: 0; /* 默认隐藏 */
            transition: opacity 0.3s; /* 添加淡入淡出效果 */
        }
        
        /* 当父级线激活时，文字显示 */
        .link-num.active { 
            opacity: 1; 
        }
        /* 图例容器 */
        .legend { 
            margin-top: 30px; 
            padding-top: 15px; 
            border-top: 1px dashed var(--paper-border); 
        }
        .legend h3 { 
            font-size: 1rem; 
            color: var(--ink); 
            margin-bottom: 10px; 
        }
        /* 单个图例项 */
        .legend-item { 
            display: flex; 
            align-items: flex-start; 
            margin-bottom: 8px; 
            font-size: 0.8rem; 
            line-height: 1.2;
        }
        /* 颜色小圆点 */
        .color-dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            margin-right: 10px; 
            margin-top: 3px;
            flex-shrink: 0;
        }
    </style>
</head>
<body>

<header>
    <div style="font-size: 1.8rem; font-weight: 600;">The New Invisible College</div>
    <div style="font-size: 0.8rem; letter-spacing: 2px; color: var(--ink-soft);">A GENEALOGY OF MODERN PHYSICS</div>
</header>

<div class="container">
    <aside class="sidebar" id="sidebar">
        <div id="intro">
            <h2>Notes</h2>
            <p style="font-size: 0.9rem; color: var(--ink-soft);">Click on a scientist to reveal their connections. Drag the background to pan, or use the buttons to zoom.</p>
        </div>
        <div id="details" style="display:none;">
            <h2 id="s-name">Scientist</h2>
            <p id="s-bio" style="font-size: 0.95rem; line-height: 1.6;"></p>
            <hr style="border: 0; border-top: 1px solid var(--paper-border); margin: 20px 0;">
            <div id="s-links"></div>
        </div>
    </aside>

    <main class="diagram-container" id="canvas">
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="manualZoom(1.25)">＋</button>
            <button class="zoom-btn" onclick="manualZoom(0.8)">－</button>
        </div>

        <svg id="scene">
            <g id="main-group"></g>
        </svg>
    </main>
</div>

<script>
/* --- 数据配置 --- */
const groups = {
    "stat":      { x: 500, y: 100, label: "Statistical Physics", color: "#e63946", desc: "Foundational laws of thermodynamics" },
    "atomic":    { x: 750, y: 150, label: "Atomic Model", color: "#f4a261", desc: "Structure of atoms and electrons" },
    "rel":       { x: 250, y: 200, label: "Relativity", color: "#2a9d8f", desc: "Space-time and gravity theories" },
    "qm":        { x: 550, y: 400, label: "Quantum Mechanics", color: "#264653", desc: "The core of modern wave mechanics" },
    "condensed": { x: 950, y: 450, label: "Condensed Matter", color: "#e9c46a", desc: "Solids, liquids, and superfluids" },
    "nuclear":   { x: 250, y: 550, label: "Nuclear Physics", color: "#a8dadc", desc: "Nuclear fission and particle research" },
    "astro":     { x: 800, y: 650, label: "Astrophysics", color: "#457b9d", desc: "Celestial bodies and cosmic limits" },
    "field":     { x: 550, y: 750, label: "Quantum Field Theory", color: "#6d597a", desc: "High energy and particle physics" }
};
/* --- 长宽比压缩逻辑 --- */
const compressY = 0.75; // 压缩率：1.0 是原状，0.75 会减少 25% 的高度
const spreadX = 1.1;    // 补偿系数：稍微拉开横向距离，防止节点重叠

Object.keys(groups).forEach(key => {
    groups[key].y = groups[key].y * compressY;
    groups[key].x = groups[key].x * spreadX;
});

const nodes = [

    // Statistical Physics (起源)
    
    { id: "boltzmann", label: "L. Boltzmann", group: "stat", bio: "Boltzmann's greatest achievements were the development of statistical mechanics and the statistical explanation of the second law of thermodynamics." },
    
    { id: "maxwell", label: "J. C. Maxwell", group: "stat", bio: "Maxwell was a key figure in the classical theory of electromagnetic radiation and the creation of statistical theory." },
    
    { id: "ehrenfest", label: "P. Ehrenfest", group: "stat", bio: "Ehrenfest made major contributions to statistical mechanics and its relation to quantum mechanics, including the theory of phase transition and the Ehrenfest theorem. " },
    
    
    
    // Atomic & Early Quantum
    
    { id: "thomson", label: "J.J. Thomson", group: "atomic", bio: "Discovered Electron." },
    
    { id: "rutherford", label: "E. Rutherford", group: "atomic", bio: "'The father of nuclear physics'. Rutherford's discoveries include the concept of radioactive half-life, the radioactive element radon, and the differentiation and naming of alpha and beta radiation." },
    
    { id: "bohr", label: "N. Bohr", group: "atomic", bio: "Bohr developed the Bohr atomic model, proposing that the energy levels of electrons are discrete, and that electrons revolve around the atomic nucleus in stable orbits, but can jump from one energy level (or orbit) to another." },
    
    { id: "planck", label: "M. Planck", group: "qm", bio: "Max Planck published his theoretical research on blackbody radiation and absorption of heat/light in 1900, thus initiating the study of quantum mechanics." },
    
    
    
    // Relativity & Roots
    
    { id: "michelson", label: "A. Michelson", group: "rel", bio: "The Michelson-Morley experiment proved that the ether does not exist." },
    
    { id: "lorentz", label: "H. Lorentz", group: "rel", bio: "Hendrick Lorentz is best known for his research on electromagnetic radiation and the Fitzgerald-Lorentz contraction. He also developed the mathematical theory of the electron." },
    
    { id: "einstein", label: "A. Einstein", group: "rel", bio: "Einstein is best know for developing special and general theories of relativity." },
    
    { id: "bose", label: "S. Bose", group: "rel", bio: "Bose-Einstein statistics. Proposed a quantum statistical method for photons." },
    
    { id: "perrin", label: "J. Perrin", group: "rel", bio: "Perrin's Brownian motion experiments confirmed the existence of atoms." },
    
    { id: "de_Broglie", label: "de Broglie", group: "rel", bio: "Louis de Broglie's most famous achievement was describing the wave-particle duality of the electron." },
    
    
    
    // Quantum Mechanics (核心层)
    
    { id: "born", label: "M. Born", group: "qm", bio: "Proposed the statistical interpretation of the wave function." },
    
    { id: "heisenberg", label: "W. Heisenberg", group: "qm", bio: "Heisenberg developed the matrix mechanics." },
    
    { id: "schrodinger", label: "E. Schrodinger", group: "qm", bio: "Schrödinger developed the wave mechanics." },
    
    { id: "pauli", label: "W. Pauli", group: "qm", bio: "Pauli is famous for Pauli Exclusion Principle, prediction of the Neutrino, Spin Theory, and the development of quantum field theory." },
    
    { id: "dirac", label: "P. Dirac", group: "qm", bio: "Dirac is known for Dirac equation, its prediction of antimatters, Quantum Electrodynamics, and Fermi-Dirac Statistics." },
    
    
    
    // Condensed Matter & Soviet School
    
    { id: "ioffe", label: "A. Ioffe", group: "condensed", bio: "Ioffe  is considered the father of Soviet physics, founding the Leningrad Physical-Technical Institute (LFTI) and pioneering studies in semiconductors, piezoelectrics, and crystal physics." },
    
    { id: "kapitsa", label: "P. Kapitsa", group: "condensed", bio: "Kapitsa discovered superfluidity." },
    
    { id: "landau", label: "L. Landau", group: "condensed", bio: "Landau explained superfluidity theoratically, proposed Landau Quantization, Landau Damping, and many other things." },
    
    
    
    // Nuclear & Astrophysics
    
    { id: "meitner", label: "L. Meitner", group: "nuclear", bio: "Meitner was instrumental in the discovery of nuclear fission. " },
    
    { id: "oppenheimer", label: "J. Oppenheimer", group: "nuclear", bio: "The leader of the Manhattan Project." },
    
    { id: "teller", label: "E. Teller", group: "nuclear", bio: "The father of the hydrogen bomb." },
    
    { id: "fermi", label: "E. Fermi", group: "nuclear", bio: "The creator of the world's first artificial nuclear reactor, the Chicago Pile-1, and a member of the Manhattan Project. " },
    
    { id: "fowler", label: "R. Fowler", group: "astro", bio: "Fowler was the first to consider the use of Fermi-Dirac Statistics in white dwarfs. He wrote Statistical thermodynamics: A version of statistical mechanics for students of physics and chemistry." },
    
    { id: "chandrasekhar", label: "S. Chandrasekhar", group: "astro", bio: "Chandrasekhar discovered the critical mass for white dwarfs (the Chandrasekhar limit)." },
    
    
    
    // High Energy & Particle (新生代)
    
    { id: "yukawa", label: "H. Yukawa", group: "field", bio: "Predicted the existence of mesons, developed the model of the strong force between hadrons" },

    { id: "feynman", label: "R. Feynman", group: "field", bio: "路径积分，费曼图。量子电动力学大师。" },
    
    { id: "sakharov", label: "A. Sakharov", group: "field", bio: "苏联氢弹之父。重子失衡理论。" },
    
    { id: "wu", label: "C.S. Wu (吴健雄)", group: "field", bio: "物理学第一夫人。实验证实了宇称不守恒。" },
    
    { id: "lee", label: "T.D. Lee (李政道)", group: "field", bio: "提出弱相互作用下宇称不守恒。" },
    
    { id: "yang", label: "C.N. Yang (杨振宁)", group: "field", bio: "杨-米尔斯场论，杨-巴克斯特方程。当代最伟大的物理学家之一。" }

];

const links = [
    { from: "boltzmann", to: "maxwell", note: "Boltzmann introduced external potential in 1868 to the Maxwell distribution that was established in 1860. This set the basis of the Boltzmann equation in 1872. (Sklar, Lawrence (1993). Physics and Chance: Philosophical Issues in the Foundations of Statistical Mechanics. New York: Cambridge University Press.)" },
    { from: "boltzmann", to: "ehrenfest", note: "Ehrenfest attended Boltzmann's lectures on the mechanical theory of heat during 1899-1900. (Boltzmann then left Vienna for Leipzig) Suddenly, thanks mainly to Boltzmann, the negative thoughts about education which he had at school were replaced with a great love for mathematics and physics. He obtained his doctorate from Vienna in 1904, under Boltzmann's supervision, on a topic in classical mechanics The motion of rigid bodies in fluids and the mechanics of Hertz.(mac tutor, the making of a theoretical physicist)" },
    { from: "boltzmann", to: "planck", note: "'In doing so he had to reject his belief that the second law of thermodynamics was an absolute law of nature, and accept Boltzmann's interpretation that it was a statistical law.' Mac tutor. Planck borrowed Boltzmann's method to avoid ultraviolet catastrophe, which led to the idea of quantum. (Although Boltzmann fought for atoms, he considered discretization merely as a mathematical approach) Planck was also the first one to establish the Boltzmann constant." },
    { from: "boltzmann", to: "einstein", note: "1905, brownian motion -> proof of the existence of atoms; Einstein further discovered that Bose's method of counting applied not only to light but also to atoms, and that it produced a remarkable condensation phenomenon at low temperatures." },
    { from: "boltzmann", to: "lorentz", note: "lorentz applied Boltzmann euqation to explore the electrons' behavior in conduction. (lorentz gas model)" },
    { from: "boltzmann", to: "thomson", note: "Thomson found electron in 1897, which was an evidence for the existence of atoms." },
    { from: "boltzmann", to: "bose", note: "Bose discovered that if the contents of the lattice were completely indistinguishable, the manual remained valid, but a different method of counting was needed.)" },
    { from: "boltzmann", to: "perrin", note: "Jean Perrin's 1908–1909 experiments on Brownian motion provided definitive, quantitative evidence for the existence of atoms and molecules" },
    { from: "boltzmann", to: "schrodinger", note: "'His line of thought may be called my first love in science, No other has ever thus enraptured me or willever do so again'. His thesis advisor and director of the secondInstitute for Experimental Physics at the University of Vienna, Franz Serafin Exner, was an ardent admirer of Boltzmann (Schrödinger, centenary celebration of a polymat,chapter 2)" },
    { from: "boltzmann", to: "meitner", note: "'A fairly typical curriculum, it washighly unusual in one respect: all of it wastaught by just one person, the theoreticalphysicist Ludwig Boltzmann' (Lise Meitner : a life in physicsby Sime, Ruth Lewin)" },
    { from: "boltzmann", to: "dirac", note: "When Fermi and Dirac derived Fermi-Dirac statistics in 1926, they completely followed Boltzmann's combinatorial mathematical logic." },
    { from: "boltzmann", to: "fermi", note: "When Fermi and Dirac derived Fermi-Dirac statistics in 1926, they completely followed Boltzmann's combinatorial mathematical logic." },
    { from: "boltzmann", to: "fowler", note: "Fowler explored Darwin-Fowler Method : Mathematically proved that the 'most probable value' is always equal to the 'average value'. Freed from dependence on Stirling's Approximation, used saddle point approximation." },
    { from: "maxwell", to: "ehrenfest", note: "/" },
    { from: "maxwell", to: "thomson", note: "/" },
    { from: "maxwell", to: "planck", note: "/" },
    { from: "maxwell", to: "michelson", note: "/" },
    { from: "maxwell", to: "lorentz", note: "/" },
    { from: "maxwell", to: "einstein", note: "/" },
    { from: "maxwell", to: "bose", note: "/" },
    { from: "maxwell", to: "fowler", note: "/" },
    { from: "ehrenfest", to: "bohr", note: "/" },
    { from: "ehrenfest", to: "lorentz", note: "/" },
    { from: "ehrenfest", to: "einstein", note: "/" },
    { from: "ehrenfest", to: "ioffe", note: "/" },
    { from: "ehrenfest", to: "landau", note: "/" },
    { from: "ehrenfest", to: "meitner", note: "Lise Meitner stuided with Ehrenfest in Boltzmann's seminar in 1905." },
    { from: "ehrenfest", to: "dirac", note: "/" },
    { from: "ehrenfest", to: "fermi", note: "/" },
    { from: "thomson", to: "rutherford", note: "/" },
    { from: "thomson", to: "bohr", note: "/" },
    { from: "thomson", to: "oppenheimer", note: "/" },
    { from: "rutherford", to: "bohr", note: "/" },
    { from: "rutherford", to: "kapitsa", note: "/" },
    { from: "rutherford", to: "meitner", note: "/" },
    { from: "rutherford", to: "oppenheimer", note: "/" },
    { from: "rutherford", to: "fowler", note: "/" },
    { from: "planck", to: "bohr", note: "/" },
    { from: "planck", to: "lorentz", note: "/" },
    { from: "planck", to: "einstein", note: "Light Quantum Hypothesis" },
    { from: "planck", to: "schrodinger", note: "/" },
    { from: "planck", to: "heisenberg", note: "/" },
    { from: "planck", to: "meitner", note: "/" },
    { from: "bohr", to: "einstein", note: "/" },
    { from: "bohr", to: "born", note: "/" },
    { from: "bohr", to: "landau", note: "/" },
    { from: "bohr", to: "pauli", note: "/" },
    { from: "bohr", to: "schrodinger", note: "/" },
    { from: "bohr", to: "heiseinberg", note: "/" },
    { from: "bohr", to: "meitner", note: "/" },
    { from: "bohr", to: "dirac", note: "/" },
    { from: "michelson", to: "lorentz", note: "/" },
    { from: "lorentz", to: "einstein", note: "/" },
    { from: "lorentz", to: "ioffe", note: "/" },
    { from: "lorentz", to: "pauli", note: "/" },
    { from: "lorentz", to: "dirac", note: "/" },
    { from: "einstein", to: "bose", note: "/" },
    { from: "einstein", to: "de_Broglie", note: "/" },
    { from: "einstein", to: "perrin", note: "/" },
    { from: "einstein", to: "dirac", note: "/" },
    { from: "einstein", to: "chandrasekhar", note: "/" },
    { from: "einstein", to: "meitner", note: "/" },
    { from: "bose", to: "landau", note: "/" },
    { from: "bose", to: "kapitsa", note: "/" },
    { from: "bose", to: "fermi", note: "/" },
    { from: "bose", to: "dirac", note: "/" },
    { from: "bose", to: "pauli", note: "?" },
    { from: "bose", to: "chandrasekhar", note: "/" },
    { from: "bose", to: "fowler", note: "/" },
    { from: "perrin", to: "de_Broglie", note: "/" },
    { from: "de_Broglie", to: "schrodinger", note: "/" },
    { from: "de_Broglie", to: "heisenberg", note: "/" },
    { from: "de_Broglie", to: "dirac", note: "/" },
    { from: "born", to: "heisenberg", note: "/" },
    { from: "born", to: "oppenheimer", note: "/" },
    { from: "born", to: "pauli", note: "/" },
    { from: "born", to: "teller", note: "/" },
    { from: "born", to: "schrodinger", note: "/" },
    { from: "born", to: "dirac", note: "/" },
    { from: "ioffe", to: "kapitsa", note: "/" },
    { from: "ioffe", to: "landau", note: "/" },
    { from: "kapitsa", to: "landau", note: "/" },
    { from: "kapitsa", to: "dirac", note: "/" },
    { from: "kapitsa", to: "fowler", note: "/" },
        ];
/* --- 初始化与布局 --- */
const mainGroup = document.getElementById('main-group');
const svg = document.getElementById('scene');

// 1. 预计算每个节点的连接数 (Degree)
nodes.forEach(n => {
    n.degree = links.filter(l => l.from === n.id || l.to === n.id).length;
});

// 2. 初始化坐标逻辑
// 2. 初始化坐标逻辑
nodes.forEach((node, i) => {
    const gCfg = groups[node.group];
    const centerX = 600; 
    
    // 【修改点】改为每行 4 个，并收紧间距，从而压扁布局
    const col = i % 4;
    const row = Math.floor(i / 4);
    const nodeSpacingX = 110; 
    const nodeSpacingY = 85; 

    const pullingForce = (node.degree > 5) ? (centerX - gCfg.x) * 0.2 : 0;
    
    // 微小偏移 (Jitter)
    const jitterX = (i % 2 === 0 ? 1 : -1) * 10;
    const jitterY = (i % 3 === 0 ? 1 : -1) * 5;

    node.x = gCfg.x + col * nodeSpacingX + pullingForce + jitterX;
    node.y = gCfg.y + row * nodeSpacingY + jitterY;
});
// 自动生成图例并挂载到侧边栏
const sidebar = document.getElementById('sidebar');
const legendBox = document.createElement('div');
legendBox.className = 'legend';
legendBox.innerHTML = '<h3>Field Legend</h3>';

Object.keys(groups).forEach(key => {
    const g = groups[key];
    legendBox.innerHTML += `
        <div class="legend-item">
            <span class="color-dot" style="background:${g.color}"></span>
            <div>
                <strong>${g.label}</strong><br>
                <span style="color: var(--ink-soft); font-size: 0.7rem;">${g.desc || ''}</span>
            </div>
        </div>`;
});
sidebar.appendChild(legendBox);

// [UPDATE] 3. 渲染连线（包含编号生成）
links.forEach((link, idx) => {
    const s = nodes.find(n => n.id === link.from);
    const t = nodes.find(n => n.id === link.to);
    if (!s || !t) return;
    
    const lineId = idx + 1; // 生成编号
    link.lineNum = lineId;  // 存入数据中

    // 绘制线
    const lEl = document.createElementNS("http://www.w3.org/2000/svg", "line");
    lEl.setAttribute("class", `link l-${link.from} l-${link.to}`);
    lEl.setAttribute("x1", s.x); lEl.setAttribute("y1", s.y);
    lEl.setAttribute("x2", t.x); lEl.setAttribute("y2", t.y);
    mainGroup.appendChild(lEl);

    // [NEW] 绘制编号文字
    const midX = (s.x + t.x) / 2;
    const midY = (s.y + t.y) / 2;
    const tEl = document.createElementNS("http://www.w3.org/2000/svg", "text");
    tEl.setAttribute("x", midX); tEl.setAttribute("y", midY);
    tEl.setAttribute("class", `link-num l-${link.from} l-${link.to}`);
    // 给编号加一点白边，防止被线条遮挡
    tEl.setAttribute("style", "font-size: 10px; fill: var(--accent); font-weight: bold; paint-order: stroke; stroke: #fff; stroke-width: 3px; pointer-events:none;");
    tEl.textContent = lineId;
    mainGroup.appendChild(tEl);
});

// [UPDATE] 4. 渲染节点（给圆圈上色）
nodes.forEach(node => {
    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    g.setAttribute("class", "node");
    const circ = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    circ.setAttribute("cx", node.x); circ.setAttribute("cy", node.y); circ.setAttribute("r", 10);
    
    // 这里设置颜色
    const groupColor = groups[node.group].color;
    circ.setAttribute("stroke", groupColor); 
    circ.setAttribute("stroke-width", "3"); // 让边框粗一点，颜色更明显
    circ.setAttribute("fill", "white");     // 保持中间是白的，干净一些
    
    const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
    txt.setAttribute("x", node.x); txt.setAttribute("y", node.y + 25);
    txt.setAttribute("text-anchor", "middle"); txt.setAttribute("class", "node-text");
    txt.textContent = node.label;
    
    g.appendChild(circ); g.appendChild(txt);
    g.onclick = (e) => { e.stopPropagation(); clickNode(node); };
    mainGroup.appendChild(g);
});

/* --- 交互控制 --- */
let scale = 1, tx = 0, ty = 0;
let isDragging = false, startX, startY;

const updateTransform = () => {
    mainGroup.setAttribute("transform", `translate(${tx},${ty}) scale(${scale})`);
};

function manualZoom(factor) {
    const oldScale = scale;
    scale *= factor;
    scale = Math.min(Math.max(scale, 0.2), 4); // 限制范围

    const rect = svg.getBoundingClientRect();
    const cx = rect.width / 2;
    const cy = rect.height / 2;
    
    tx = cx - (cx - tx) * (scale / oldScale);
    ty = cy - (cy - ty) * (scale / oldScale);
    updateTransform();
}

svg.onmousedown = (e) => {
    if(e.button !== 0) return;
    isDragging = true;
    startX = e.clientX - tx;
    startY = e.clientY - ty;
};

window.onmousemove = (e) => {
    if (!isDragging) return;
    tx = e.clientX - startX;
    ty = e.clientY - startY;
    updateTransform();
};

window.onmouseup = () => isDragging = false;

// 降低滚轮灵敏度
svg.onwheel = (e) => {
    e.preventDefault();
    const oldScale = scale;
    const delta = e.deltaY > 0 ? 0.96 : 1.04; // 极其微小的缩放
    scale *= delta;
    scale = Math.min(Math.max(scale, 0.2), 4);

    const rect = svg.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    tx = mouseX - (mouseX - tx) * (scale / oldScale);
    ty = mouseY - (mouseY - ty) * (scale / oldScale);
    updateTransform();
};

function clickNode(node) {
    document.getElementById('intro').style.display = 'none';
    const det = document.getElementById('details');
    det.style.display = 'block';
    document.getElementById('s-name').textContent = node.label;
    document.getElementById('s-bio').innerHTML = node.bio;

    // 高亮连线
    document.querySelectorAll('.link').forEach(l => l.classList.remove('active'));
    document.querySelectorAll(`.l-${node.id}`).forEach(l => l.classList.add('active'));
    // 1. 先清除所有线和数字的激活状态
    document.querySelectorAll('.link, .link-num').forEach(el => el.classList.remove('active'));
    
    // 2. 为当前科学家相关的线和数字添加激活状态
    document.querySelectorAll(`.l-${node.id}`).forEach(el => el.classList.add('active'));
    const rels = links.filter(l => l.from === node.id || l.to === node.id);
    
    // 1. 按组进行归类
    const groupedRels = {};
    rels.forEach(r => {
        const otherId = r.from === node.id ? r.to : r.from;
        const otherNode = nodes.find(n => n.id === otherId);
        if (!otherNode) return;
        
        const gKey = otherNode.group;
        if (!groupedRels[gKey]) groupedRels[gKey] = [];
        groupedRels[gKey].push({ link: r, target: otherNode });
    });

    // 2. 构造 HTML
    let html = '';
    for (const gKey in groupedRels) {
        const groupInfo = groups[gKey];
        const items = groupedRels[gKey];
        
        // 创建一个该领域的“大包裹框”
        html += `
            <div style="background: ${groupInfo.color}15; border-radius: 8px; padding: 12px; margin-bottom: 20px; border: 1px solid ${groupInfo.color}33;">
                <h4 style="margin: 0 0 10px 0; color: ${groupInfo.color}; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">
                    ${groupInfo.label}
                </h4>
        `;

        // 在框内渲染具体的关系
        html += items.map(item => `
            <div class="relation-box" style="background: white; margin-top: 8px; border-left: 3px solid ${groupInfo.color};">
                <small style="color:var(--ink-soft);">[Line #${item.link.lineNum}]</small><br>
                <strong>With ${item.target.label}:</strong><br>
                ${item.link.note}
            </div>
        `).join('');

        html += `</div>`; // 闭合大包裹框
    }

    document.getElementById('s-links').innerHTML = html || '<p>No specific records found.</p>';

    if (window.MathJax && window.MathJax.typeset) {
        MathJax.typeset();
    }
}
</script>
</body>
</html>
